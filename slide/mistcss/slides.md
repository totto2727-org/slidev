---
title: MistCSSでいろいろ試してみた
author: '@totto2727'
favicon: 'https://cdn.jsdelivr.net/gh/slidevjs/slidev/assets/favicon.png'
htmlAttrs:
  lang: ja
# Theme
theme: geist
fonts:
  sans: "M PLUS 2"
  mono: "M PLUS 1 Code"
transition: slide-left
lineNumbers: true
# Feature
mdc: true
drawings:
  persist: false
---

# MistCSSでいろいろ試してみた

**とっと / ![株式会社ゆめみ](/YUMEMI_yoko_WH_08.svg){.inline-img}**{.opacity-100}

---

## 自己紹介

:::div{class="grid grid-cols-[auto_1fr] items-between"}

- ニックネーム：**とっと**
- 所属： ![/YUMEMI_yoko_WH_08.svg](/YUMEMI_yoko_WH_08.svg){.inline-img}
- 職種：フロントエンドエンジニア
- 推しFW：**Remix**, **Astro**
- 推し：<tamu>棗いつき</tamu> <nakutya>藍月なくる</nakutya>
  - [布教用Playlist](https://music.youtube.com/playlist?list=PLou8tAEUf2ouel_LDAvj5fMi6Kzb2EYfM&si=yBpASHEsVbyDM-UM)

![とっとのアイコン](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj8jkLUdX62rBSF0DpJbWNxeUnEqmwHsy-L0FYI_DfF7Hbv8i74385AGc5wY57nVD8LKVjh_RC1FapEinm4tcGdr5SAtjxTNAb2oPMT8fF-TjDtreQIF5zLX8PyqSsR8SSmN7qdGMvartw/s800/character_program_shutdown.png){.w-[20rem].mx-auto}

:::

---

## MistCSSってなに？

::div{.text-center.pb-8}

Atomic DesignのAtom相当をCSSから生成するツール

<https://typicode.github.io/mistcss/>

::

---

## 生成されるコード

::div{.flex.justify-center.items-center.gap-8}

```css
/* 元となるCSS */
@scope (button.custom-button) {
  :scope {
    background: black;
    color: white;

    &[data-variant="primary"] {
      background: blue;
    }

    &[data-variant="secondary"] {
      background: gray;
    }
  }
}
```

```ts
// Generated by MistCSS, do not modify
import "./Button.mist.css";

import type { JSX, PropsWithChildren } from "react";

type Props =
  & { variant?: "primary" | "secondary" }
  & JSX.IntrinsicElements["button"];

export function CustomButton(
  { children, variant, ...props }: PropsWithChildren<Props>,
) {
  return (
    <button {...props} data-variant={variant} className="custom-button">
      {children}
    </button>
  );
}
```

::

---

::div{.flex.flex-col.justify-center.items-center}

```astro
---
// Generated by MistCSS, do not modify
import type { HTMLAttributes } from "astro/types";
import "./Button.mist.css";

type Props = { variant?: "primary" | "secondary" } & HTMLAttributes<"button">;

const { variant, ...props } = Astro.props;
---

<button {...props} data-variant={variant} class="custom-button"><slot /></button
>
```

```svelte
<script lang="ts">
// Generated by MistCSS, do not modify
import type { SvelteHTMLElements } from "svelte/elements";
import "./Button.mist.css";

type Props =
  & { variant?: "primary" | "secondary" }
  & SvelteHTMLElements["button"];

type $$Props = Props;

const { variant, ...props } = $$props;
</script>

<button {...props} data-variant={variant} class="custom-button"><slot /></button
>
```

::

---

## 対応しているフレームワーク

- React
- Vue
- Astro
- Hono
- Svelte（PRレビュー中）

ロジック自体非常にシンプルなので、他のフレームワークも簡単に対応できると思います

---

## レンダラーの実装（Props）

```ts
function renderProps(data: Data): string {
  return [
    "const {",
    [
      ...Object.keys(data.attributes).map(attributeToCamelCase),
      ...Array.from(data.booleanAttributes).map(attributeToCamelCase),
      ...Array.from(data.properties).map(propertyToCamelCase),
      "...props",
    ].join(", "),
    "} = $$props",
  ].join(" ");
}
```

---

## レンダラーの実装（全体）

```ts
export function render(filename: string, data: Data): string {
  return `<script lang="ts">
// Generated by MistCSS, do not modify
import type { SvelteHTMLElements } from 'svelte/elements'
import './${filename}.mist.css'
${renderPropsInterface(data, `SvelteHTMLElements['${data.tag}']`)}
type $$Props = Props
${renderProps(data)}
</script>
${renderTag(data, "<slot />", "class", "svelte")}
`;
}
```

---

## 使い方

1. `hoge.mist.css`を作成
2. `npx mistcss --target react hoge.mist.css`

`--watch`オプションもあるよ

---

## いいところ

- CSS単体から様々なフレームワークに対応可能
  - デザインシステム案件で使えないかなと思っている
- UIとロジックが分離される
- CSSの書き方がある程度矯正される
  - CSS変数など利用が促進される
  - [大体竹内さん推奨の書き方になる](https://qiita.com/honey32/items/ac72d3c1ba66b412f9bc)
- @applyとかtheme関数を使えば、Tailwind CSSやUnoCSSと併用可能

---

## 微妙なところ

- 現状、複数フレームワークの同時出力に対応していない
  - 後でPRを出す予定
  - `npx mistcss --target react --target svelte --target astro hoge.mist.css`
- Viteなどの統合が無い
  - 後でPRを出す予定
  - Plugin用にCore機能をエクスポートするところから

---

```ts
export const unpluginFactory: UnpluginFactory<Options | undefined> = (
  options,
) => {
  const targets: [Target, Extension][] = parseTargets(options?.targets ?? []);

  let isBuild = false;

  return {
    name: "unplugin-mistcss",
    enforce: "pre",
    async buildStart() {
      if (isBuild) return;

      const files = fs.promises.glob(path.join("**/*.mist.css"));

      const promises: Promise<unknown>[] = [];

      for await (const file of files) {
        const content = await fs.promises.readFile(file, "utf8");
        const data = parse(content);
        console.log(
          "mistcss:",
          "create",
          path.relative(process.cwd(), file),
          options?.targets ?? [],
        );
        promises.push(createFiles(data, file, targets));
      }

      await Promise.all(promises);
      isBuild = true;
    },
    async watchChange(id, { event }) {
      if (!id.endsWith(".mist.css")) return;

      if (event === "create" || event === "update") {
        console.log(
          "mistcss:",
          "update",
          path.relative(process.cwd(), id),
          options?.targets ?? [],
        );

        fs.promises
          .readFile(id, "utf8")
          .then((str) => {
            return parse(str);
          })
          .then((data) => {
            for (const [target, extension] of targets) {
              createFile(data, id, target, extension);
            }
          });
      } else {
        // TODO delete files
      }
    },
  };
};
```

---

## 致命的な課題

::div{.flex.justify-center.items-start.gap-8}

- `@scope`を利用できるブラウザの普及率が低い
  - 80%ぐらい
  - というかFirefoxではExperimental
  - 公式のPolyfillも無い（PostCSSで検討中）
  - 無理やりPolyfillはできるけど…

```ts
export const lightningcssVisitorScope = composeVisitors([
  {
    Rule: {
      scope(rule) {
        if (!rule.value.scopeStart) return undefined;

        return [
          // The original ASTs are intact.
          rule,
          {
            type: "style",
            value: {
              selectors: rule.value.scopeStart.map((selectors) => [
                {
                  type: "attribute",
                  name: "data-unsupport-scope",
                  operation: {
                    operator: "equal",
                    value: "true",
                  },
                },
                { type: "combinator", value: "descendant" },
                ...selectors,
              ]),
              loc: rule.value.loc,
              rules: rule.value.rules.map((rule_) => {
                if (rule_.type !== "style") return rule_;
                return {
                  ...rule_,
                  value: {
                    ...rule_.value,
                    selectors: rule_.value.selectors.map((selectors) => [
                      {
                        type: "nesting",
                      },
                      ...selectors.filter(
                        (selector) =>
                          selector.type !== "pseudo-class"
                          || selector.kind !== "scope",
                      ),
                    ]),
                  },
                };
              }),
            },
          },
        ];
      },
    },
  },
]);
```

::

---

## おわり

- 現状案件に導入するのは難しい
- ただ、デザインシステムを構築してための方針としては、筋が良さそう
- 今後も積極的にコミットしていつか案件で使いたい
